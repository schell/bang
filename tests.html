<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8">
        <title>tests</title>
        <script src="mod.js" type="text/javascript" charset="utf-8"></script>
        <script src="http://schell.github.com/go/go.js" type="text/javascript" charset="utf-8"></script>
        <link rel="shortcut icon" href="favicon.png" />
    </head>
    <body id="tests">
        <script type="text/javascript" charset="utf-8">
            mod.useTagInjection = true;
            mod.expansions = {
                bang : 'src/'
            };
            mod({
                name : 'main',
                dependencies : [ 
                    'bang::Global.js',
                    'bang::View/Stage.js'
                ],
                init : function initMain(m) {
                    return function exporter() {
                        return m;
                    };
                }
            }).onload(function afterload(m) {
                var assert = m.assert;
                var src = mod.compile();
                
                function newBangContext() {
                    /** * * 
                    * Evaluates a clean version of our code and gets the
                    * modules from our export function above..
                    * * **/
                    var main = eval(src);
                    var modules = main();
                    return modules;
                }
                
                var m1 = newBangContext();
                m.assert.eq('main' in m1, true, 'Can get new bang eval.');
                var m1stage = m1.Stage();
                
                var m2 = newBangContext();
                m.assert.eq('main' in m2, true, 'Can get another bang eval.');
                var m2stage = m2.Stage();
                
                m1stage.addListener(m1stage, m1.Stage.FRAME_TICK, function(note) {});
                
                assert.eq(m1stage.noteCenter.observers().length-1, m2stage.noteCenter.observers().length, 'Can add observers to bang context and contexts are seperate.');
                
                function canGetMouseOverAfterMouseLeave(cb) {
                    console.log('canGetMouseOverAfterMouseLeave test');
                    
                    var b = newBangContext();
                    var div = document.createElement('div');
                    document.body.appendChild(div);
                    var stage = b.Stage();
                    stage.setParentElement(div);
                    
                    var over = false;
                    var moved = false;
                    // Add an interest in mouseLeave and mouseOver...
                    stage.addListener(stage, b.Stage.MOUSE_LEAVE, function() {
                        over = false;
                    });
                    stage.addListener(stage, b.View.MOUSE_MOVE, function() {
                        moved = true;
                    });
                    stage.addListener(stage, b.View.MOUSE_OVER, function() {
                        over = true;
                    });
                    // Send a fake mouse event...
                    stage.canvas.onmousemove({offsetX:1,offsetY:1});
                    assert.eq(over, true, 'Can get mouse over event.');
                    stage.canvas.onmousemove({offsetX:1,offsetY:1});
                    assert.eq(moved, true, 'Can get mouse move event.');
                    stage.canvas.onmouseout({offsetX:-100,offsetY:1});
                    assert.eq(over, false, 'Can get mouse leave event.');
                    stage.canvas.onmousemove({offsetX:1,offsetY:1});
                    assert.eq(over, true, 'Can get mouse over event again.');
                    
                    stage.remove();
                    document.body.removeChild(div);
                    cb();
                }
                
                go(
                    canGetMouseOverAfterMouseLeave,
                    m.assert.stat
                ).start();
            });
            
        </script>
    </body>